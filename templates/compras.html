{% extends "base.html" %}
{% block content %}
<div class="page-header d-flex justify-content-between align-items-center mb-3">
    <h2>ðŸ“¦ Compras</h2>
</div>

<div id="alert-placeholder"></div>

<div class="card mb-3 p-3">
    <form id="line-form" onsubmit="return false;">
        <div class="row g-2">
            <div class="col-md-4">
                <label class="form-label">Proveedor</label>
                <div class="input-group mb-2">
                    <select id="proveedor" class="form-select">
                        <option value="">-- Selecciona proveedor --</option>
                        {% for p in proveedores %}
                        <option value="{{ p.id }}">{{ p.nombre }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="btn btn-outline-primary" onclick="toggleFormProveedor()">âž•</button>
                </div>

                <div id="form-nuevo-proveedor" style="display:none; margin-top:5px;">
                    <input id="prov_nombres" class="form-control mb-1" placeholder="Nombres">
                    <input id="prov_apellidos" class="form-control mb-1" placeholder="Apellidos">
                    <input id="prov_telefono" class="form-control mb-1" placeholder="TelÃ©fono">
                    <input id="prov_correo" class="form-control mb-1" placeholder="Correo">
                    <input id="prov_direccion" class="form-control mb-1" placeholder="DirecciÃ³n">
                    <div class="d-grid">
                        <button type="button" class="btn btn-primary" onclick="guardarProveedor()">Guardar Proveedor</button>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <label class="form-label">Producto</label>
                <div class="input-group mb-2">
                    <select id="producto" class="form-select">
                        <option value="">-- Selecciona producto --</option>
                        {% for p in productos %}
                        <option value="{{ p.id }}" data-costo="{{ p.costo }}">{{ p.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="col-md-2">
                <label class="form-label">Cantidad</label>
                <input type="number" id="cantidad" class="form-control" min="1" value="1">
            </div>

            <div class="col-md-2">
                <label class="form-label d-block">&nbsp;</label>
                <button type="button" class="btn btn-primary w-100" onclick="addProduct()">âž• Agregar</button>
            </div>
        </div>
    </form>
</div>

<div class="card mb-3">
    <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
            <thead class="table-dark">
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Costo</th>
                    <th>Total</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="line-items">
                </tbody>
        </table>
    </div>
    <div class="card-footer text-end">
        <h5 class="mb-0">Total: <span id="total-compra">0.00</span></h5>
    </div>
</div>

<div class="card mb-3 p-3">
    <div class="row g-2">
        <div class="col-md-3">
            <label class="form-label">Fecha</label>
            <input type="date" id="fecha" class="form-control" value="{{ fecha }}">
        </div>
        <div class="col-md-3">
            <label class="form-label">NÃºmero de Compra</label>
            <input type="text" id="compra-num" class="form-control" value="{{ compra_num }}" readonly>
        </div>
        <div class="col-md-3">
            <label class="form-label">Forma de Pago</label>
            <select id="forma-pago" class="form-select">
                <option>Efectivo</option>
                <option>CrÃ©dito</option>
                <option>Transferencia</option>
            </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-success w-100" onclick="saveCompra()">ðŸ’¾ Guardar Compra</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
    document.getElementById('cantidad').addEventListener('change', (e) => {
        if (e.target.value < 1) e.target.value = 1;
    });
});

function addProduct() {
    const productoSelect = document.getElementById('producto');
    const cantidadInput = document.getElementById('cantidad');
    
    const productoId = productoSelect.value;
    const productoNombre = productoSelect.options[productoSelect.selectedIndex].text;
    const cantidad = parseFloat(cantidadInput.value);
    
    if (!productoId || !cantidad || cantidad <= 0) {
        return;
    }
    
    // Obtiene el costo del producto desde el atributo data
    const costo = parseFloat(productoSelect.options[productoSelect.selectedIndex].dataset.costo);
    const total = cantidad * costo;
    
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td><input type="hidden" name="producto_id[]" value="${productoId}">${productoNombre}</td>
        <td><input type="number" name="cantidad[]" class="form-control cantidad-input" value="${cantidad}" min="1"></td>
        <td><input type="hidden" name="costo[]" value="${costo}">${costo.toFixed(2)}</td>
        <td><span class="total-span">${total.toFixed(2)}</span></td>
        <td><button class="btn btn-sm btn-danger remove-btn" onclick="this.closest('tr').remove(); calculateTotal();">X</button></td>
    `;
    document.getElementById('line-items').appendChild(newRow);
    calculateTotal();
}

function calculateTotal() {
    const totalElement = document.getElementById('total-compra');
    let total = 0;
    const totalSpans = document.querySelectorAll('#line-items .total-span');
    totalSpans.forEach(span => {
        total += parseFloat(span.textContent);
    });
    totalElement.textContent = total.toFixed(2);
}

async function saveCompra() {
    const tableBody = document.querySelector('#line-items');
    const rows = tableBody.querySelectorAll('tr');
    
    if (rows.length === 0) {
        showAlert('Agrega al menos un producto a la compra.', 'danger');
        return;
    }
    
    const lines = Array.from(rows).map(row => {
        const productoId = row.querySelector('input[name="producto_id[]"]').value;
        const cantidad = parseFloat(row.querySelector('input[name="cantidad[]"]').value);
        const costo = parseFloat(row.querySelector('input[name="costo[]"]').value);
        const total = cantidad * costo;

        return {
            producto_id: parseInt(productoId),
            cantidad: cantidad,
            costo: costo,
            total: total
        };
    });

    const proveedorId = document.getElementById('proveedor').value;
    const compraNum = document.getElementById('compra-num').value;
    const fecha = document.getElementById('fecha').value;
    const formaPago = document.getElementById('forma-pago').value;

    const payload = {
        proveedor_id: proveedorId,
        numero: compraNum,
        fecha: fecha,
        forma_pago: formaPago,
        lines: lines
    };

    try {
        const res = await fetch("{{ url_for('compras_save') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) {
            showAlert(`Compra ${data.compra_num} guardada con Ã©xito.`, 'success');
            setTimeout(() => { location.reload(); }, 2000);
        } else {
            showAlert("Error: " + data.error, 'danger');
        }
    } catch (err) {
        showAlert("Error de conexiÃ³n: " + err.message, 'danger');
    }
}

function showAlert(msg, type) {
    const ph = document.getElementById('alert-placeholder');
    ph.innerHTML=`<div class=\"alert alert-${type} alert-dismissible\" role=\"alert\">${msg}<button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button></div>`;
}

// Funciones para formulario inline de proveedor
function toggleFormProveedor(){
    const form=document.getElementById("form-nuevo-proveedor");
    form.style.display=(form.style.display==='none')?'block':'none';
}

async function guardarProveedor(){
    const payload={
        nombres: document.getElementById("prov_nombres").value,
        apellidos: document.getElementById("prov_apellidos").value,
        telefono: document.getElementById("prov_telefono").value,
        correo: document.getElementById("prov_correo").value,
        direccion: document.getElementById("prov_direccion").value,
        tipo:"Proveedor"
    };
    try{
        const res=await fetch("{{ url_for('add_tercero') }}",{
            method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
        });
        const data=await res.json();
        if(data.success){
            const sel=document.getElementById("proveedor");
            sel.innerHTML+=`<option value=\"${data.id}\" selected>${data.nombre}</option>`;
            document.getElementById("form-nuevo-proveedor").style.display='none';
            document.getElementById("form-nuevo-proveedor").querySelectorAll("input").forEach(i=>i.value='');
        } else { alert("Error: "+data.error); }
    }catch(err){ alert("Error de conexiÃ³n: "+err.message); }
}
</script>
{% endblock %}



