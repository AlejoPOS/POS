{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h3 class="mb-3">Nota de Crédito - Factura #{{ factura.numero }}</h3>

    <form method="post" action="{{ url_for('save_nota_credito') }}">
        <input type="hidden" name="factura_id" value="{{ factura.id }}">

        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label">Número Nota Crédito</label>
                <input type="text" class="form-control" name="numero" value="{{ next_num }}" readonly>
            </div>
            <div class="col-md-3">
                <label class="form-label">Fecha</label>
                <input type="date" class="form-control" name="fecha" value="{{ factura.fecha }}">
            </div>
            <div class="col-md-6">
                <label class="form-label">Motivo</label>
                <input type="text" class="form-control" name="motivo" required>
            </div>
        </div>

        <h5 class="mt-3">Detalle de la Nota Crédito</h5>
        <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th>Producto</th>
                    <th>Cantidad Facturada</th>
                    <th>Cantidad Devolver</th>
                    <th>Precio</th>
                    <th>Total Línea</th>
                </tr>
            </thead>
            <tbody>
                {% for d in detalle %}
                <tr>
                    <td>
                        {{ d.descripcion }}
                        <input type="hidden" name="producto_id[]" value="{{ d.producto_id }}">
                        <input type="hidden" name="descripcion[]" value="{{ d.descripcion }}">
                    </td>
                    <td>{{ d.cantidad }}</td>
                    <td>
                        <input type="number" step="0.01" max="{{ d.cantidad }}" min="0"
                               name="cantidad[]" class="form-control form-control-sm cantidad-input"
                               data-precio="{{ d.precio }}" value="0">
                    </td>
                    <td>
                        <input type="text" name="precio[]" value="{{ d.precio }}" readonly
                               class="form-control form-control-sm">
                    </td>
                    <td>
                        <input type="text" name="total_linea[]" value="0" readonly
                               class="form-control form-control-sm total-linea">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="4" class="text-end">TOTAL NOTA CRÉDITO</th>
                    <th>
                        <input type="text" name="total" id="total-general" class="form-control" readonly value="0">
                    </th>
                </tr>
            </tfoot>
        </table>

        <div class="d-flex justify-content-between">
            <a href="{{ url_for('ver_factura', factura_id=factura.id) }}" class="btn btn-secondary">
                Cancelar
            </a>
            <button type="submit" class="btn btn-success">
                Guardar Nota Crédito
            </button>
        </div>
    </form>
</div>

<script>
// === Calcular totales dinámicamente ===
document.querySelectorAll(".cantidad-input").forEach(input => {
    input.addEventListener("input", () => {
        let row = input.closest("tr");
        let precio = parseFloat(input.dataset.precio);
        let cantidad = parseFloat(input.value) || 0;
        let total = precio * cantidad;
        row.querySelector(".total-linea").value = total.toFixed(2);

        // Calcular total general
        let totalGeneral = 0;
        document.querySelectorAll(".total-linea").forEach(t => {
            totalGeneral += parseFloat(t.value) || 0;
        });
        document.getElementById("total-general").value = totalGeneral.toFixed(2);
    });
});
</script>
{% endblock %}
